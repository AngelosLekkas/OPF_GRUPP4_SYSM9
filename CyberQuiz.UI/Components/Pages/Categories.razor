@page "/categories"
@using CyberQuiz.Shared.DTOs
@rendermode InteractiveServer
@inject NavigationManager Navigation

@* =========================================
   KOMMER ANVÄNDAS – API/BLL
   Avkommenteras när backend är klart
========================================= *@
@* @inject IQuizApiClient QuizApi *@

<PageTitle>Categories</PageTitle>

<h2 class="mb-4 text-center">Choose a Category</h2>

<div class="row g-4">
    @* =========================================
       SKA BORT – använder dummy categories
       Byts mot apiCategories senare
    ========================================= *@
    @foreach (var category in categories)
    {
        <div class="col-md-3">
            <div class="card shadow-sm border-primary category-card">

                <div class="card-body text-center">
                    <h5 class="card-title fw-bold">@category.Name</h5>

                    <button class="btn btn-primary mt-3 w-75"
                            @onclick="() => ToggleCategory(category.Id)">
                        @(expandedCategoryId == category.Id ? "Collapse" : "Open")
                    </button>
                </div>

                @* =========================================
                   Subcategories (DUMMY) – SKA BORT
                ========================================= *@
                @if (expandedCategoryId == category.Id)
                {
                    <ul class="list-group list-group-flush border-top mt-2">

                        @* SKA BORT – använder category.SubCategories *@
                        @foreach (var sub in category.SubCategories)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <div>
                                    <strong>@sub.Name</strong><br />
                                    <small class="text-muted">@sub.QuestionCount questions</small>
                                </div>

                                @if (sub.IsLocked)
                                {
                                    <span class="text-danger fs-5">🔒</span>
                                }
                                else if (sub.IsCompleted)
                                {
                                    <span class="text-success fs-5">✅</span>
                                }
                                else
                                {
                                    <span class="text-secondary fs-5">⭕</span>
                                }

                                @if (!sub.IsLocked)
                                {
                                    <button class="btn btn-success btn-sm ms-2"
                                            @onclick="() => StartQuiz(sub.Id)">
                                        Start
                                    </button>
                                }
                            </li>
                        }
                    </ul>
                }

                @* =========================================
                   KOMMER ANVÄNDAS – API VERSION
                   (avkommenteras vid merge)
                ========================================= *@
                @*
                @if (expandedCategoryId == category.Id && apiSubCategories.ContainsKey(category.Id))
                {
                    <ul class="list-group list-group-flush border-top mt-2">

                        @foreach (var sub in apiSubCategories[category.Id])
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <div>
                                    <strong>@sub.Name</strong><br />
                                    <small class="text-muted">@sub.QuestionCount questions</small>
                                </div>

                                <span>
                                    @(sub.IsLocked ? "🔒" :
                                      sub.IsCompleted ? "✅" : "⭕")
                                </span>

                                @if (!sub.IsLocked)
                                {
                                    <button class="btn btn-success btn-sm ms-2"
                                            @onclick="() => StartQuiz(sub.Id)">
                                        Start
                                    </button>
                                }
                            </li>
                        }
                    </ul>
                }
                *@

            </div>
        </div>
    }
</div>

@code {

    // =========================================
    // SKA BORT – DUMMY DATA
    // =========================================
    private List<CategoryModel> categories = new()
    {
        new CategoryModel
        {
            Id = 1,
            Name = "Nätverkssäkerhet",
            SubCategories = new()
            {
                new() { Id = 11, Name = "Sub 1", QuestionCount = 5, IsLocked = false, IsCompleted = true },
                new() { Id = 12, Name = "Sub 2", QuestionCount = 3, IsLocked = true, IsCompleted = false }
            }
        }
    };
    // =========================================


    // =========================================
    // KOMMER ANVÄNDAS – API/BLL
    // =========================================
    private List<CategoryDto> apiCategories = new();
    private Dictionary<int, List<SubCategoryDto>> apiSubCategories = new();

    private string userId = "user"; // SKA BYTAS → Identity
    // =========================================


    // =========================================
    // STATE (BEHÅLLS)
    // =========================================
    private int? expandedCategoryId = null;
    // =========================================


    // =========================================
    // KOMMER ANVÄNDAS – async för API
    // =========================================
    private async Task ToggleCategory(int categoryId)
    {
        if (expandedCategoryId == categoryId)
        {
            expandedCategoryId = null;
            return;
        }

        expandedCategoryId = categoryId;

        // =========================================
        // KOMMER ANVÄNDAS – API CALL
        // =========================================
        /*
        if (!apiSubCategories.ContainsKey(categoryId))
        {
            var subs = await QuizApi.GetSubCategoriesAsync(categoryId, userId);
            apiSubCategories[categoryId] = subs;
        }
        */
    }
    // =========================================


    private void StartQuiz(int subCategoryId)
    {
        Navigation.NavigateTo($"/questions/{subCategoryId}");
    }


    // =========================================
    // SKA BORT – DUMMY MODELLER
    // =========================================
    private class CategoryModel
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public List<SubCategoryDto> SubCategories { get; set; } = new();
    }

    private class SubCategoryDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public int QuestionCount { get; set; }
        public bool IsLocked { get; set; }
        public bool IsCompleted { get; set; }
    }
    // =========================================
}