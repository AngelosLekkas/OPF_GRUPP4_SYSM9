@page "/questions/{SubCategoryId:int}"
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Questions</PageTitle>

<h3 class="mb-4 text-center">QUIZ</h3>

@if (!quizFinished && currentQuestion != null)
{
    <div class="card p-4 shadow-sm">

        @*Fråga*@
        <h5>@currentQuestion.Text</h5>

        @*Svarsalternativ*@
        @foreach (var option in currentQuestion.Options)
        {
            <div class="form-check mt-2">

                <input type="radio"
                       class="form-check-input"
                       name="answer"
                       value="@option.Id"
                       checked="@(selectedAnswerId == option.Id)"
                       @onchange="() => SelectAnswer(option.Id)"
                       disabled="@answered" />

                    <label class="form-check-label">
                        @option.Text
                    </label>
            </div>
        }

        @*submit-knapp*@
        <button class="btn btn-primary mt-3"
            @onclick="SubmitAnswer"
            disabled="@(selectedAnswerId == null || answered)">
            Submit
        </button>

        @*Feedback*@
        @if (answered)
        {
            <div class="mt-3">
                @if (isCorrect)
                {
                    <div class="alert alert-success">
                        Correct ✅
                    </div>
                }
                else
                {
                    <div class="alert alert-danger">
                        Wrong ❌
                    </div>
                }
            </div>
        }

        @*nästa fråga*@
        @if (answered)
        {
            <button class="btn btn-secondary mt-2"
                @onclick="NextQuestion">
                Next Question
            </button>
        }
    </div>
}

@if (quizFinished)
{
    <div class="card p-4 shadow-sm text-center">

        <h4>Quiz Finished 🎉</h4>

        <p class="mt-3">
            You got <strong>@correctAnswers</strong> out of <strong>@questions.Count</strong> correct
        </p>

        <p>
            Score: <strong>@((correctAnswers * 100) / questions.Count)%</strong>
        </p>

        <button class="btn btn-primary mt-3"
                @onclick="GoToCategories">
            Back to Categories
        </button>
    </div>
}

@code {
    [Parameter]
    public int SubCategoryId { get; set; }

    private QuestionModel? currentQuestion;

    private int? selectedAnswerId;
    private bool answered = false;
    private bool isCorrect = false;

    private int questionIndex = 0;

    // Dummy frågor (simulerar API senare)
    private List<QuestionModel> questions = new()
    {
        new QuestionModel
        {
            Id = 1,
            Text = "What does HTTPS stand for?",
            Options = new()
            {
                new() { Id = 1, Text = "HyperText Transfer Protocol Secure", IsCorrect = true },
                new() { Id = 2, Text = "High Transfer Text Protocol", IsCorrect = false },
                new() { Id = 3, Text = "Hyper Tool Transfer Protocol", IsCorrect = false }
            }
        },
        new QuestionModel
        {
            Id = 2,
            Text = "What is phishing?",
            Options = new()
            {
                new() { Id = 4, Text = "A cyber attack using fake emails", IsCorrect = true },
                new() { Id = 5, Text = "A type of encryption", IsCorrect = false }
            }
        }
    };

    protected override void OnInitialized()
    {
        currentQuestion = questions[0];
    }

    private void SelectAnswer(int answerId)
    {
        selectedAnswerId = answerId;
    }

    private void SubmitAnswer()
    {
        var selected = currentQuestion!.Options
            .First(o => o.Id == selectedAnswerId);

        isCorrect = selected.IsCorrect;
        if (isCorrect)
        {
            correctAnswers++;
        }
        answered = true;

        // Här kommer API senare
        // await QuizService.SubmitAnswer(...)
    }

    private void NextQuestion()
    {
        questionIndex++;

        if (questionIndex < questions.Count)
        {
            currentQuestion = questions[questionIndex];

            // reset state
            selectedAnswerId = null;
            answered = false;
            isCorrect = false;
        }
        else
        {
            quizFinished = true;
        }
    }

    // Models (tillfälliga)
    private class QuestionModel
    {
        public int Id { get; set; }
        public string Text { get; set; } = "";
        public List<AnswerOption> Options { get; set; } = new();
    }

    private class AnswerOption
    {
        public int Id { get; set; }
        public string Text { get; set; } = "";
        public bool IsCorrect { get; set; }
    }

    //tillfälligt
    private int correctAnswers = 0;
    /* håller koll på hur många rätt användaren fått */

    private bool quizFinished = false;
    /* avgör om vi ska visa resultat istället för frågor */

    private void GoToCategories()
    {
        Navigation.NavigateTo("/categories");
    }
}