@page "/categories"
@using CyberQuiz.Shared.DTOs
@using System.Security.Claims
@using CyberQuiz.UI.Services
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject IQuizApiClient QuizApi

@rendermode InteractiveServer

<h3 class="mb-4 text-center">Categories</h3>

<div class="row g-4">

    @foreach (var category in categoriesFromApi)
    {
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card p-3 shadow-sm">

                <h5>@category.Name</h5>

                <button class="btn btn-primary mt-2"
                        @onclick="() => ToggleCategory(category.Id)">
                    Open
                </button>

                @if (expandedCategoryId == category.Id && subCategoriesMap.ContainsKey(category.Id))
                {
                    <ul class="list-group mt-3">

                        @foreach (var sub in subCategoriesMap[category.Id])
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <div>
                                    <strong>@sub.Name</strong><br />
                                    <small>@sub.QuestionCount questions</small>
                                </div>

                                <span>
                                    @(sub.IsLocked ? "🔒" :
                                      sub.IsCompleted ? "✅" : "⭕")
                                </span>

                                @if (!sub.IsLocked)
                                {
                                    <button class="btn btn-success btn-sm"
                                            @onclick="() => StartQuiz(sub.Id)">
                                        Start
                                    </button>
                                }
                            </li>
                        }

                    </ul>
                }

            </div>
        </div>
    }

</div>

@code {

    private string? userId;

    private List<CategoryDto> categoriesFromApi = new();
    private Dictionary<int, List<SubCategoryDto>> subCategoriesMap = new();

    private int? expandedCategoryId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        if (userId != null)
        {
            categoriesFromApi = await QuizApi.GetCategoriesAsync(userId);
        }
    }

    private async Task ToggleCategory(int categoryId)
    {
        if (expandedCategoryId == categoryId)
        {
            expandedCategoryId = null;
        }
        else
        {
            expandedCategoryId = categoryId;

            if (!subCategoriesMap.ContainsKey(categoryId))
            {
                var subs = await QuizApi.GetSubCategoriesAsync(categoryId, userId!);
                subCategoriesMap[categoryId] = subs;
            }
        }
    }

    private void StartQuiz(int subCategoryId)
    {
        Navigation.NavigateTo($"/questions/{subCategoryId}");
    }
}