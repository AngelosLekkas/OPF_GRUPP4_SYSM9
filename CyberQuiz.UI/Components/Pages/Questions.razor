@page "/questions/{SubCategoryId:int}"
@using CyberQuiz.Shared.DTOs
@inject NavigationManager Navigation
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider

@* =========================================
   KOMMER ANVÄNDAS – API/BLL
========================================= *@
@inject IQuizApiClient QuizApi

@rendermode InteractiveServer

<PageTitle>Questions</PageTitle>

<h3 class="mb-4 text-center">QUIZ</h3>

@* =========================================
   QUIZ VIEW
========================================= *@
@if (!quizFinished && currentQuestion != null)
{
    <div class="card p-4 shadow-sm">

        @* Fråga *@
        <h5>@currentQuestion.Text</h5>

        @* =========================================
           SKA BORT – använder dummy Options
        ========================================= *@
        @foreach (var option in currentQuestion.Options)
        {
            <div class="form-check mt-2">

                <input type="radio"
                       class="form-check-input"
                       name="answer"
                       value="@option.Id"
                       checked="@(selectedAnswerId == option.Id)"
                       @onchange="() => SelectAnswer(option.Id)"
                       disabled="@answered" />

                <label class="form-check-label">
                    @option.Text
                </label>
            </div>
        }

        @* =========================================
           KOMMER ANVÄNDAS – API VERSION
        ========================================= *@
        @*
        @foreach (var option in currentQuestion.AnswerOptions)
        {
            <div class="form-check mt-2">

                <input type="radio"
                       class="form-check-input"
                       @bind="selectedAnswerId"
                       @bind-value="option.Id"
                       disabled="@answered" />

                <label class="form-check-label">
                    @option.Text
                </label>
            </div>
        }
        *@


        @* Submit *@
        <button class="btn btn-primary mt-3"
                @onclick="SubmitAnswer"
                disabled="@(selectedAnswerId == null || answered)">
            Submit
        </button>

        @* Feedback *@
        @if (answered)
        {
            <div class="mt-3">
                <div class="alert @(isCorrect ? "alert-success" : "alert-danger")">
                    @(isCorrect ? "Correct ✅" : "Wrong ❌")
                </div>
            </div>
        }

        @* Next *@
        @if (answered)
        {
            <button class="btn btn-secondary mt-2"
                    @onclick="NextQuestion">
                Next Question
            </button>
        }
    </div>
}

@* =========================================
   RESULT VIEW
========================================= *@
@if (quizFinished)
{
    <div class="card p-4 shadow-sm text-center">

        <h4>Quiz Finished 🎉</h4>

        <p class="mt-3">
            You got <strong>@correctAnswers</strong> out of <strong>@questions.Count</strong> correct
        </p>

        <p>
            Score: <strong>@((correctAnswers * 100) / questions.Count)%</strong>
        </p>

        <button class="btn btn-primary mt-3"
                @onclick="GoToCategories">
            Back to Categories
        </button>
    </div>
}

@code {

    [Parameter]
    public int SubCategoryId { get; set; }

    // =========================================
    // SKA BORT – DUMMY DATA
    // =========================================
    private List<QuestionModel> questions = new()
    {
        new QuestionModel
        {
            Id = 1,
            Text = "What does HTTPS stand for?",
            Options = new()
            {
                new() { Id = 1, Text = "Correct answer", IsCorrect = true },
                new() { Id = 2, Text = "Wrong answer", IsCorrect = false }
            }
        }
    };


    // Hämtar inloggad användares ID från Identity
    // Detta skickas till API så vi kan få personlig progression
    private string? userId;

    private QuestionModel? currentQuestion;
    // =========================================


    // =========================================
    // KOMMER ANVÄNDAS – API/BLL
    // =========================================
    private List<QuestionDto> apiQuestions = new();

    //private string userId = "user"; // SKA BYTAS → Identity
    // =========================================


    // =========================================
    // STATE (BEHÅLLS)
    // =========================================
    private int? selectedAnswerId;
    private bool answered = false;
    private bool isCorrect = false;
    private int questionIndex = 0;

    private int correctAnswers = 0;
    private bool quizFinished = false;
    // =========================================


    // =========================================
    // INIT
    // =========================================
    protected override async Task OnInitializedAsync()
    {
        //  Hämta userId från Identity
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        // =========================================
        // SKA BORT – DUMMY INIT
        // =========================================
        currentQuestion = questions.FirstOrDefault();

        // =========================================
        // KOMMER ANVÄNDAS – API
        // =========================================
        /*
        if (userId != null)
        {
            apiQuestions = await QuizApi.GetQuestionsAsync(SubCategoryId, userId);
            currentQuestion = apiQuestions.FirstOrDefault();
        }
        */
    }


    // =========================================
    // SELECT ANSWER
    // =========================================
    private void SelectAnswer(int answerId)
    {
        selectedAnswerId = answerId;
    }


    // =========================================
    // SUBMIT
    // =========================================
    private async Task SubmitAnswer()
    {
        // =========================================
        // SKA BORT – dummy logik
        // =========================================
        var selected = currentQuestion!.Options
            .First(o => o.Id == selectedAnswerId);

        isCorrect = selected.IsCorrect;
        if (isCorrect)
            correctAnswers++;

        answered = true;

        // =========================================
        // KOMMER ANVÄNDAS – API
        // =========================================
        /*
        var response = await QuizApi.SubmitAnswerAsync(userId,
            new SubmitAnswerRequestDto
            {
                QuestionId = currentQuestion!.Id,
                AnswerOptionId = selectedAnswerId!.Value
            });

        isCorrect = response.IsCorrect;
        answered = true;

        if (response.IsCorrect)
            correctAnswers++;
        */
    }


    // =========================================
    // NEXT QUESTION
    // =========================================
    private void NextQuestion()
    {
        questionIndex++;

        if (questionIndex < questions.Count) // SKA BORT → apiQuestions.Count
        {
            currentQuestion = questions[questionIndex];

            selectedAnswerId = null;
            answered = false;
            isCorrect = false;
        }
        else
        {
            quizFinished = true;
        }
    }


    private void GoToCategories()
    {
        Navigation.NavigateTo("/categories");
    }


    // =========================================
    // SKA BORT – DUMMY MODELLER
    // =========================================
    private class QuestionModel
    {
        public int Id { get; set; }
        public string Text { get; set; } = "";
        public List<AnswerOption> Options { get; set; } = new();
    }

    private class AnswerOption
    {
        public int Id { get; set; }
        public string Text { get; set; } = "";
        public bool IsCorrect { get; set; }
    }
    // =========================================
}